# GPUs - Graphics Processing Units

​		本文旨在对现代图形处理单元进行更深入的研究。 它以Nvidia的“ Geforce”系列芯片为例，探讨了它们的体系结构和底层设计原理。

## 1引言

在深入研究示例GPU的体系结构细节之前，我们将了解一些图形处理和3D图形的基本概念，这将使我们更容易理解GPU的功能。
### 1.1什么是GPU？

GPU（图形处理单元）本质上是专用的硬件设备，负责将数据转换为由像素形成的2D图像。 在本文中，我们将专注于3D图形，因为这是现代GPU的主要设计目标。
### 1.2 3D场景的剖析

![image-20200329215651052](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200329215651052.png)

​																		图1：一个3D场景

3D场景：3D对象和灯光的集合。

![image-20200329215920256](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200329215920256.png)

​																图2：对象，三角形和顶点

3D对象：几何形状由三角形组成的任意对象。 三角形又由顶点组成。

顶点：具有空间坐标和其他信息（例如颜色和纹理坐标）的点。

![image-20200329220344164](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200329220344164.png)

​														图3：一个具有棋盘纹理的立方体

纹理：映射到3D对象表面的图像，它会产生对象由某种材料组成的的错觉。 对象的顶点存储了的纹理坐标（二维向量），该纹理坐标指定了如何将纹理映射到任何给定表面上。

![image-20200329221023362](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200329221023362.png)

​												图4：一个具有砖纹理的三角形和它的纹理坐标表示

为了将这样的3D场景转换为2D图像，数据必须经过“图形管线”的多个阶段

### 1.3 图形管线

![image-20200329222517414](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200329222517414.png)

​															图5：3D图形管线

#### 1.3.0 应用程序阶段

首先，除其他操作外，我们必须将应用程序提供的数据从3D转换为2D。
#### 1.3.1几何阶段
​		此阶段也称为“变换和光照”阶段。为了将场景从3D转换为2D，在将3D图像投影到2D平面之前，需要将场景中所有对象变换到多个的空间------每个空间都有其自己的坐标系。这些变换是基于顶点到顶点的。
**数学原理**
 		3D空间中的点通常具有3个坐标，用于指定其位置。如果我们使用3维向量进行变换计算，则会遇到一个问题，即不同的变换需要不同的操作（例如：平移顶点需要与向量相加，而旋转顶点需要与3x3矩阵相乘）。我们可以通过将3维向量扩展一个坐标（w坐标）来解决这个问题，从而得到所谓的齐次坐标。这样,每种变换可以通过将向量与特定的4x4矩阵相乘来实现，从而使计算变得更加容易。

![image-20200329223222249](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200329223222249.png)

​													图6：用于平移，旋转和缩放的变换矩阵

​		光照是此管线阶段的另一主要部分，是使用对象表面的法向量进行计算的。 通过结合摄像机的位置和光源的位置，可以计算给定顶点的光照属性。

![image-20200330215136136](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200330215136136.png)

​										图7：计算光照(其中P点位表面上一点,N为该点的法向量)

​		为了进行变换，我们从模型空间开始，每个对象（模型）都有自己的坐标系这被称为模型空间，这有助于进行几何变换，例如平移，旋转和缩放。

![image-20200330215802207](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200330215802207.png)

​		之后，我们将对象(模型)变换到世界空间，在世界空间下场景中的所有对象都使用统一的坐标系。

![image-20200330220104529](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200330220104529.png)

​																		图8：世界空间坐标

​		下一步是变换到视图空间，将摄影机放置在世界空间中，然后变换场景，将场景变换到以使摄影机为原点的视图空间中，摄像机看向视图空间的z轴正方向。 现在我们可以定义一个视图体积，即所谓的视锥，它将用来确定实际可见和需要渲染的内容。

![image-20200330221802768](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200330221802768.png)

​												图9：摄像机/眼睛，视锥及其剪切平面

​		之后，顶点将变换到裁剪空间并组装为图元（三角形或直线），从而建立了所谓的裁剪过程。 对于位于视锥体外部的对象不需要被渲染可以被丢弃，但是部分位于视锥体内部的对象（裁剪由此得名）需要被修剪，并且需要创建具有适当纹理坐标和颜色坐标的新顶点 。

​		然后执行透视除法，将视锥体转换为立方体，该立方体具有规范化坐标（x轴和y轴的值在-1和1之间，z轴的值在0和1之间），同时相应地缩放了在视锥体当中的对象。 拥有这个规范化的立方体有助于剪切操作，并建立投影到2D空间中（只需简单地“展平”立方体即可）。

![image-20200331221359764](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200331221359764.png)

​																		图10：变换为裁剪空间

​		最后，我们变换到屏幕空间，在其中x和y坐标需要被变换以进行正确的2D显示（在给定窗口中）。（注意，顶点的z坐标需要被保留以供之后的深度操作使用）

![image-20200331221753359](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200331221753359.png)

​																图11：从视图空间到屏幕空间

​		注意，纹理坐标也需要进行变换，此外，除了裁剪外，不可见的表面还应被删除（例如立方体的背面）（即所谓的背面剔除）。

#### 1.3.2光栅化阶段

​		管线的下一个阶段是光栅化阶段。 GPU需要遍历2D图像并将数据转换为许多个“像素候选”（所谓的片段），这些片段之后可能会成为最终图像的像素。 片段是一种数据结构，包含诸如位置，颜色，深度，纹理坐标等属性，通过判断任意给定图元与屏幕上的哪些像素相交而生成。 如果一个片段与一个图元相交，但不与图元的任何顶点相交，则该片段的属性值必须通过在顶点之间进来插值来获得。

![image-20200331224419583](C:\Users\tionerter\AppData\Roaming\Typora\typora-user-images\image-20200331224419583.png)

​														图12：栅格化二个三角形并将其颜色值进行插值

​		之后，可以进行进一步的操作以获得最终像素。 通过将纹理与其他属性（例如颜色和光照）组合在一起来计算颜色，或者将一个片段与另一个半透明片段（所谓的alpha混合）或与可选的雾化效果（另一种图形效果）相结合来计算颜色。

**进行可见性判断，例如：**